# Dafny 归并排序实现

（按：本文由 Gemini 2.5 Pro 生成。）

本文档介绍了 `mergesort.dfy` 文件中定义的归并排序算法的 Dafny 实现。该实现利用 Dafny 的规范和证明能力来确保算法的正确性。

## 模块：`MergeSort`

整个实现包含在 `MergeSort` 模块中。

### 断言：`Sorted`

这是一个 `ghost predicate` (幽灵断言)，用于在规范中定义序列已排序的属性。它断言序列中的任意两个元素，如果第一个元素的索引小于或等于第二个元素的索引，则第一个元素的值也必须小于或等于第二个元素的值。

```dafny
ghost predicate Sorted(a: seq<int>)
{
    forall i, j :: 0 <= i <= j < |a| ==> a[i] <= a[j]
}
```

### 方法：`MergeInPlace`

此方法将两个已排序的数组段（`a[aBegin..aEnd]` 和 `b[bBegin..bEnd]`）合并到一个目标数组 `r` 中。

- **前置条件 (requires):**
    - 输入数组 `a` 和 `b` 不能与结果数组 `r` 是同一个。
    - 数组段的边界必须有效。
    - 输入的数组段必须是已排序的。
    - 结果数组 `r` 必须有足够的空间。
- **后置条件 (ensures):**
    - 合并后，`r` 的元素的多重集（multiset）与两个输入段的元素的多重集之和相等，确保没有元素丢失或增加。
    - 结果数组 `r` 是已排序的。

### 方法：`CopyBack`

一个辅助方法，用于将临时数组 `tmp` 中的内容复制回原数组 `a` 的指定段 `a[begin..end]`。

### 方法：`MergeSortAux`

这是归并排序的核心递归辅助函数。

- 它接收一个数组 `a`、要排序的范围 `[begin, end)` 以及一个临时数组 `tmp`。
- 如果范围内的元素少于 2 个，则直接返回。
- 否则，它将范围一分为二，并对两个子范围递归调用自身。
- 然后，它调用 `MergeInPlace` 将两个已排序的子范围合并到 `tmp` 数组中。
- 最后，调用 `CopyBack` 将 `tmp` 中已排序的结果复制回 `a`。
- **终止条件 (decreases):** 递归调用的终止性由 `end - begin` 的值递减来保证。

### 方法：`MergeSort`

这是用户调用的主方法。

- 它接收一个数组 `a`。
- 创建一个与 `a` 等长的临时数组 `tmp`。
- 调用 `MergeSortAux` 对整个数组 `(0, a.Length)` 进行排序。
- **后置条件 (ensures):**
    - 排序后，整个数组 `a` 是有序的。
    - 排序后的数组 `a` 的元素多重集与原始数组相同，保证了排序的稳定性（就元素集合而言）。
